Model CASTEP, Test phonon_Ti3Al
Test run at 2019-10-31 13:09

model file: ../../models/CASTEP/model.py
============================================================
import os
from distutils import spawn

#from matscipy.socketcalc import CastepClient, SocketCalculator
from ase.calculators.castep import Castep

model_abs_dir = os.path.abspath(os.path.dirname(__file__))

mpirun = "aprun"
mpirun_args = "-n 48"
castep = "castep.mpi"

os.environ['CASTEP_COMMAND'] = '{0} {1} {2}'.format(mpirun, mpirun_args, castep)

print os.environ['CASTEP_COMMAND']

name = 'CASTEP'
Castep.name = name
Castep.todict = lambda self: {}

no_checkpoint = True

def start(test_name):
        global calculator
	calculator = Castep(directory="./_CASTEP",
                        cut_off_energy=600, #700
                        max_scf_cycles=250,
                        calculate_stress=True,
                        finite_basis_corr='automatic',
                        smearing_width='0.1', #0.1
                        #elec_energy_tol='0.0000001',
                        #elec_method='edft',
                        #nextra_bands='13',
                        mixing_scheme='Pulay',
                        kpoints_mp_spacing='0.04', #0.015
                        #perc_extra_bands=150,
                        write_checkpoint='none')

============================================================
test file: /fs3/e89/e89/casv2/ship-testing-framework/scripts/../tests/TiAl/phonon_Ti3Al/test.py
============================================================
from ase import Atoms
from phonopy import Phonopy
from phonopy.structure.atoms import PhonopyAtoms
import numpy as np
import matplotlib
matplotlib.use('agg')
import matplotlib.pyplot as plt
from quippy import Potential
import quippy
import os
import sys
from ase.io import read, write
import pickle

import phonopy
from phonopy.phonon.band_structure import get_band_qpoints_and_path_connections

import model

calc = model.calculator

def get_crystal():
    at = read(os.path.join(os.path.abspath(os.path.dirname(__file__)), "bulk.xyz"))

    cell = PhonopyAtoms(symbols=at.get_chemical_symbols(),
                    cell=at.get_cell(),
                    positions=at.get_positions())

    return cell

def phonopy_pre_process(cell, supercell_matrix=None):

    smat = [[2,0,0], [0,2,0], [0,0,2]]


    phonon = Phonopy(cell,
                     smat)

    phonon.generate_displacements(distance=0.01)
    print("[Phonopy] Atomic displacements:")
    disps = phonon.get_displacements()
    for d in disps:
        print("[Phonopy] %d %s" % (d[0], d[1:]))
    return phonon

def run(calc, phonon):
    supercells = phonon.get_supercells_with_displacements()
    # Force calculations by calculator
    set_of_forces = []
    for (i,scell) in enumerate(supercells):
        ##########
        at = Atoms(symbols=scell.get_chemical_symbols(),
                      scaled_positions=scell.get_scaled_positions(),
                      cell=scell.get_cell(),
                      pbc=True)

        at.set_calculator(calc)

        energy = at.get_potential_energy(force_consistent=True)
        forces = at.get_forces()
        stress = at.get_stress(voigt=False)

        drift_force = forces.sum(axis=0)
        print(("[Phonopy] Drift force:" + "%11.5f" * 3) % tuple(drift_force))
        # Simple translational invariance
        for force in forces:
            force -= drift_force / forces.shape[0]

        at.arrays["force"] = forces
        at.info["virial"] = -1.0 * at.get_volume() * stress
        at.info["energy"] = energy

        write("{}_scell.xyz".format(i), at)
        set_of_forces.append(forces)
    return set_of_forces

cell = get_crystal()

phonon = phonopy_pre_process(cell, supercell_matrix=np.eye(3, dtype='intc'))
set_of_forces = run(calc, phonon)
phonon.produce_force_constants(forces=set_of_forces)

path = [[[0, 0, 0], [-0.5, 0.5, 0.5], [0.25, 0.25, 0.25], [0, 0, 0], [0, 0.5, 0]]]
labels = ["$\\Gamma$", "H", "P", "$\\Gamma$", "N"]
qpoints, connections = get_band_qpoints_and_path_connections(path, npoints=51)

phonon.run_band_structure(qpoints, path_connections=connections, labels=labels)
#phonon.run_band_structure(qpoints, path_connections=connections, labels=labels)
phonon.plot_band_structure().show()
#plt.savefig
#phonon.set_mesh([21, 21, 21])
#phonon.set_total_DOS(tetrahedron_method=True)

#phonon.get_total_DOS()


#print model.name

#try:
#    model_name = model.orig_dir.split("/")[-1].split("-")[2]
#except:
#    model_name = model.pot_name.split("/")[-2]#.split("-")[2]

#print split(split(model.orig_dir, "/")[-1], "-")[2]
#print vars(model)
#print dict(model)

phonon.write_yaml_band_structure(filename="data.yaml")


#fig, plt = phonon.plot_band_structure_2()

#plt.savefig("test.png")



#phonon.run_mesh([20, 20, 20])
#phonon.run_thermal_properties(t_step=10,
#                              t_max=1000,
#                              t_min=0)


#band_dict = phonon.get_band_structure_dict()

#print band_dict
#print band_dict.keys()


#phonon.plot_band_structure().show()


#pickle.dump(phonon, file('phonon2.pickle', 'w'))



#plt.savefig("band.png")

#properties = { 'band_dict' : band_dict, 'set_of_forces' : set_of_forces}
============================================================
aprun -n 48 castep.mpi
[Phonopy] Atomic displacements:
[Phonopy] 0 [0.007770407952052887, 2.4789181908649637e-07, 0.0062945023788400405]
[Phonopy] 0 [-0.007770407952052887, -2.4789181908649637e-07, -0.0062945023788400405]
[Phonopy] 0 [-0.004999727613504624, 0.008660411294549433, -8.198104926732725e-11]
[Phonopy] 0 [0.004999727613504624, -0.008660411294549433, 8.198104926732725e-11]
[Phonopy] 8 [0.007770407952052887, 2.4789181908649637e-07, 0.0062945023788400405]
[Phonopy] 8 [-0.007770407952052887, -2.4789181908649637e-07, -0.0062945023788400405]
[Phonopy] 8 [-0.004999727613504624, 0.008660411294549433, -8.198104926732725e-11]
[Phonopy] 8 [0.004999727613504624, -0.008660411294549433, 8.198104926732725e-11]
[Phonopy] 16 [0.007770407952052887, 2.4789181908649637e-07, 0.0062945023788400405]
[Phonopy] 16 [-0.007770407952052887, -2.4789181908649637e-07, -0.0062945023788400405]
[Phonopy] 16 [-0.004999727613504624, 0.0086604112945494castep call stdout:
Application 37671407 resources: utime ~152536s, stime ~1718s, Rss ~1571172, inblocks ~143462, outblocks ~322831
No regular end found in /fs3/e89/e89/casv2/ship-testing-framework/example_run_dir/TiAl/run_dir/run_TiAl-model-CASTEP-test-phonon_Ti3Al/_CASTEP/castep.castep file
None
[Phonopy] Drift force:   -0.00003    0.00005    0.00002
castep call stdout:
Application 37672407 resources: utime ~151841s, stime ~1701s, Rss ~1571956, inblocks ~143660, outblocks ~322838
[Phonopy] Drift force:    0.00001   -0.00000    0.00000
castep call stdout:
Application 37673170 resources: utime ~151449s, stime ~1731s, Rss ~1571116, inblocks ~143805, outblocks ~322844
[Phonopy] Drift force:    0.00001   -0.00000    0.00000
castep call stdout:
Application 37673763 resources: utime ~147164s, stime ~1671s, Rss ~1571052, inblocks ~143924, outblocks ~322842
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
castep call stdout:
Application 37674421 resources: utime ~156756s, stime ~1789s, Rss ~1567764, inblocks ~143532, outblocks ~322834
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
castep call stdout:
Application 37675106 resources: utime ~151772s, stime ~1698s, Rss ~1571444, inblocks ~143567, outblocks ~322836
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
============================================================
Property calculation output:

Traceback (most recent call last):
  File "../../../scripts/run-model-test.py", line 138, in <module>
    json.dump(test.properties, json_file)
AttributeError: 'module' object has no attribute 'properties'
0.0062945023788400405]
[Phonopy] 56 [-0.004999727613504624, 0.008660411294549433, -8.198104926732725e-11]
[Phonopy] 56 [0.004999727613504624, -0.008660411294549433, 8.198104926732725e-11]
castep call stdout:
Application 37671666 resources: utime ~141029s, stime ~1582s, Rss ~1345636, inblocks ~144042, outblocks ~320881
[Phonopy] Drift force:   -0.00002   -0.00001    0.00002
castep call stdout:
Application 37672541 resources: utime ~134121s, stime ~1608s, Rss ~1436048, inblocks ~144234, outblocks ~320879
[Phonopy] Drift force:    0.00001   -0.00000    0.00000
castep call stdout:
Application 37673190 resources: utime ~133939s, stime ~1624s, Rss ~1435872, inblocks ~143631, outblocks ~320870
[Phonopy] Drift force:    0.00001   -0.00000    0.00000
castep call stdout:
Application 37673724 resources: utime ~134834s, stime ~1641s, Rss ~1439860, inblocks ~144233, outblocks ~320878
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
castep call stdout:
Application 37674323 resources: utime ~135167s, stime ~1638s, Rss ~1439788, inblocks ~143739, outblocks ~320871
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
castep call stdout:
Application 37674920 resources: utime ~133201s, stime ~1613s, Rss ~1440080, inblocks ~144135, outblocks ~320875
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
castep call stdout:
Application 37675573 resources: utime ~134279s, stime ~1596s, Rss ~1436008, inblocks ~143845, outblocks ~320873
[Phonopy] Drift force:   -0.00000    0.00001    0.00001
castep call stdout:
Application 37676263 resources: utime ~133221s, stime ~1613s, Rss ~1436272, inblocks ~143963, outblocks ~320879
[Phonopy] Drift force:    0.00004    0.00003    0.00001
castep call stdout:
Application 37676854 resources: utime ~132975s, stime ~1609s, Rss ~1440060, inblocks ~144021, outblocks ~320879
[Phonopy] Drift force:   -0.00003   -0.00005   -0.00003
castep call stdout:
Application 37677474 resources: utime ~133006s, stime ~1593s, Rss ~1440072, inblocks ~143939, outblocks ~320876
[Phonopy] Drift force:    0.00001   -0.00001    0.00000
castep call stdout:
Application 37678011 resources: utime ~133635s, stime ~1580s, Rss ~1436312, inblocks ~144291, outblocks ~320877
[Phonopy] Drift force:    0.00004    0.00001   -0.00002
castep call stdout:
Application 37678199 resources: utime ~131924s, stime ~1607s, Rss ~1436120, inblocks ~144005, outblocks ~320877
[Phonopy] Drift force:    0.00000   -0.00003    0.00002
castep call stdout:
Application 37678493 resources: utime ~133286s, stime ~1573s, Rss ~1440020, inblocks ~144029, outblocks ~320875
[Phonopy] Drift force:   -0.00003    0.00004    0.00001
castep call stdout:
Application 37678702 resources: utime ~131932s, stime ~1606s, Rss ~1439812, inblocks ~143898, outblocks ~320877
[Phonopy] Drift force:   -0.00001   -0.00001   -0.00001
castep call stdout:
Application 37678915 resources: utime ~134434s, stime ~1599s, Rss ~1435992, inblocks ~143892, outblocks ~320872
[Phonopy] Drift force:   -0.00002    0.00001    0.00002
castep call stdout:
Application 37679175 resources: utime ~133633s, stime ~1631s, Rss ~1440036, inblocks ~144063, outblocks ~320880
[Phonopy] Drift force:    0.00002   -0.00001    0.00002
castep call stdout:
Application 37679556 resources: utime ~132284s, stime ~1585s, Rss ~1439952, inblocks ~143930, outblocks ~320874
[Phonopy] Drift force:    0.00000   -0.00000    0.00000
castep call stdout:
Application 37679929 resources: utime ~132944s, stime ~1624s, Rss ~1439800, inblocks ~144242, outblocks ~320880
[Phonopy] Drift force:   -0.00001    0.00001    0.00002
castep call stdout:
Application 37680318 resources: utime ~133591s, stime ~1601s, Rss ~1435976, inblocks ~143800, outblocks ~320873
[Phonopy] Drift force:   -0.00003    0.00000   -0.00002
castep call stdout:
Application 37680711 resources: utime ~132052s, stime ~1575s, Rss ~1440032, inblocks ~144129, outblocks ~320876
[Phonopy] Drift force:    0.00002    0.00001   -0.00002
castep call stdout:
Application 37681098 resources: utime ~133643s, stime ~1610s, Rss ~1436128, inblocks ~144262, outblocks ~320877
[Phonopy] Drift force:   -0.00000   -0.00001    0.00006
castep call stdout:
Application 37681482 resources: utime ~133811s, stime ~1600s, Rss ~1435996, inblocks ~143690, outblocks ~320873
[Phonopy] Drift force:   -0.00001    0.00003    0.00000
castep call stdout:
Application 37681902 resources: utime ~134838s, stime ~1591s, Rss ~1436016, inblocks ~144110, outblocks ~320871
[Phonopy] Drift force:   -0.00003    0.00002    0.00004
castep call stdout:
Application 37682341 resources: utime ~130055s, stime ~1540s, Rss ~1439996, inblocks ~143687, outblocks ~320870
[Phonopy] Drift force:    0.00001    0.00000   -0.00003
castep call stdout:
Application 37682870 resources: utime ~134375s, stime ~1653s, Rss ~1435976, inblocks ~143867, outblocks ~320877
[Phonopy] Drift force:    0.00001    0.00001    0.00001
castep call stdout:
Application 37683326 resources: utime ~133550s, stime ~1596s, Rss ~1439708, inblocks ~143678, outblocks ~320876
[Phonopy] Drift force:   -0.00002   -0.00001    0.00001
castep call stdout:
Application 37683758 resources: utime ~135283s, stime ~1649s, Rss ~1439936, inblocks ~143641, outblocks ~320874
[Phonopy] Drift force:   -0.00003    0.00004   -0.00002
castep call stdout:
Application 37684312 resources: utime ~134198s, stime ~1624s, Rss ~1436044, inblocks ~143948, outblocks ~320880
[Phonopy] Drift force:    0.00001   -0.00002    0.00000
castep call stdout:
Application 37684739 resources: utime ~132408s, stime ~1615s, Rss ~1439924, inblocks ~143913, outblocks ~320873
[Phonopy] Drift force:   -0.00001   -0.00003    0.00000
castep call stdout:
Application 37685043 resources: utime ~134956s, stime ~1631s, Rss ~1440028, inblocks ~144047, outblocks ~320880
[Phonopy] Drift force:   -0.00004    0.00003    0.00001
